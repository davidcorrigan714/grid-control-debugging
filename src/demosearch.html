<!DOCTYPE html>

<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>

<script src="js/bootstrap.min.js"></script>
<script src="js/jstree.min.js"></script>
<script src="js/bootstrap-datepicker.min.js"></script>

<link href="css/jstree/style.min.css" rel="stylesheet">
<link href="css/bootstrap-datepicker.min.css" rel="stylesheet">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/jquery-ui.min.css"  rel="stylesheet" >
<script src="https://unpkg.com/lunr/lunr.js"></script>

<body>

<input id="searchQuery" type="text"><br/>
<select id="products" size="10">

</select>


</body>

<head>
  <script src="libs/VSS.SDK.min.js"></script>

  <script>
      var localURL = 'https://azdo-dev.natinst.com:8443';
      var products = [];
      var runLocal = true;

      var getDoc = function(file){
        return new Promise(function(resolve, reject)
        {
          if(runLocal){
            //Run Locally
            $.ajax({url: localURL+"/devGetDoc?doc="+file, success: function(result){
              resolve(result);
            }});
          }else{
            // Run on VSS          
            // Get data service
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
              // Get document by id
              dataService.getDocument("ProductCollection", file).then(function(file) {
                resolve(file.data);
              }, function (err){
                reject(err); // test for err.status == 404
              });
          });
          }
        });
      }

      var idx = {};

      function LoadProductList(cb){
        getDoc('allproducts').then(function(result)
          {
            var productList = JSON.parse(result);
            products = [];

            for(i in productList){
                products.push({name: productList[i].name, key:productList[i].key + ";"})
                for(x in productList[i].children){
                    products.push({name: productList[i].name + ": " + productList[i].children[x].name, key:productList[i].key + "," + productList[i].children[x].key + ";"})
                }
            }

            idx = lunr(function() {
                this.ref('index');
                this.field('name');
                for (i in products) {
                    products[i].index=i;
                    this.add(products[i]);
                }
            });
          }, function(err){
            
          }
        );
      }

      $("#searchQuery").on('input',function (){
        $("#products").empty();
        var results = idx.search($(this).val());
        for(i in results){
            $("#products").append("<option value=\"" + results[i].ref + "\">" + products[results[i].ref].name + "</option>")
        }
      });

      $("#products").on('change', function(){
        console.log(products[$(this).val()].name);
      });

      LoadProductList();

  </script>
</body>
</html>