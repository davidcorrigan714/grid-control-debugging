<!DOCTYPE html>

<link href="css/jquery-ui.min.css"  rel="stylesheet" >
<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>

<head>
  <script src="libs/VSS.SDK.min.js"></script>
  <script>
    // Sets up the initial handshake with the host frame
    VSS.init({applyTheme: true, explicitNotifyLoaded: true});

    // http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
    function GetURLParameter(sParam)
    {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++)
      {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
      }
    }

    var initialProduct = GetURLParameter('key');

    var selectorDialog = (function(id) {
        var callbacks = [];

        function inputChanged() {
            // Execute registered callbacks
            for(var i = 0; i < callbacks.length; i++) {
                callbacks[i](isValid());
            }
        }

        function isValid() {
            // Check whether form is valid or not
            return true;
        }

        function getFormData() {
            // Get form values
            return {
                productName: $("#product-name").html(),
                productKey: $("#key-name").html()
            };
        }

        return {
            isFormValid: function() {
                return isValid();   
            },
            getFormData: function() {
                return getFormData();
            },
            attachFormChanged: function(cb) {
                  callbacks.push(cb);
            }
        };
    })();

    // Register form object to be used across this extension
    VSS.register("form-selector-dialog", selectorDialog);
  </script>
</head>
<body>

  <div>
    Product:</br>
    <select id="products"></select></br></br>
    Version:</br>
    <select id="products-1"></select></br></br>
    Edition (optional):  </br>
    <select id="products-2"></select></br></br>
    <div id="key-name" hidden="true"></div>
    <div id="product-name"  hidden="true"></div>
  </div>

  <script>
      var runLocal = false;
      var localURL = 'https://azdo-dev.natinst.com:8443';
      var pmdmProducts = [];
      var loadedProducts = false;

      function getDoc(file, cb)
      {
        if(runLocal){
          //Run Locally
          $.ajax({url: localURL+"/devGetDoc?doc="+file, success: function(result){
            cb(result);
          }});
        }else{
          // Run on VSS          
          // Get data service
          VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
              // Get document by id
              dataService.getDocument("ProductCollection", file).then(function(file) {
                cb(file.data);
              }, function (err){
                console.log(err);
              });
          });
        }
      }

      function loadData()
      {
          // TODO: Error handle the doc failing to load
          getDoc('products', function(result)
            {
                pmdmProducts = JSON.parse(result);
                $('#products').append("<option value=\"\"></option>");
                for(product in pmdmProducts){
                    $('#products').append("<option value=\"" + product + "\">" + pmdmProducts[product].text + "</option>");
                }                   
                updateProductDropdowns();
                VSS.notifyLoadSucceeded();
            }
          );
      }

      subProducts = [];

      function updateProductDropdowns(){
        var product = pmdmProducts[$('#products').val()];
        // TODO Catch failure
        if(typeof(product) == "undefined" || product.length == 0 || !product.children){
          $('#products-1').empty();
          $("#products-2").empty();
        }else
        getDoc('product-'+product.key, function(result)
        {
          subProducts = JSON.parse(result);
          $('#products-1').empty();
          $("#products-2").empty();
          $('#products-1').append("<option value=\"\"></option>");
          for(product in subProducts.children){
            $('#products-1').append("<option value=\"" + subProducts.children[product].key + "\">" + subProducts.children[product].text + "</option>");
          }
          updateLabel();
        });
      }

      $('#products').on("change",function (){
        updateProductDropdowns();
        updateLabel();
      });

      $('#products-2').on("change", function () { updateLabel();   });

      $('#products-1').on("change", function () { 
        $('#products-2').empty();
        $('#products-2').append("<option value=\"\"></option>");
        for(product in subProducts.children){
          if(subProducts.children[product].key ==  $('#products-1').val()){
            for(edition in subProducts.children[product].children){
              $('#products-2').append("<option value=\"" + subProducts.children[product].children[edition].key + "\">" + subProducts.children[product].children[edition].text + "</option>");
            }
          }
        }
        updateLabel();
      });
      
      function updateLabel()
      {
        var product = pmdmProducts[$('#products').val()].key || "";
        var version = $('#products-1').val() || "";
        var edition = $('#products-2').val() || "";
        
        var fullKey = product;

        // There's probably some fancy concise way of doing this, but it works for now.
        if(version.length > 0)
        {
          fullKey = fullKey + "," + version;
          if(edition.length > 0){
            fullKey = fullKey + "," + edition;
          }
        }

        $('#key-name').html(fullKey);
        $('#product-name').html(($('#products option:selected').text() + ' ' + $('#products-1 option:selected').text() + ' ' + $('#products-2 option:selected').text()).trim());
      }

      loadData();
  </script>
</body>
</html>