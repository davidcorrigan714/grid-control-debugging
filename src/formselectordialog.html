<!DOCTYPE html>

<script src="js/jquery.min.js"></script>
<script src="js/lunr.min.js"></script>

<head>
  <script src="libs/VSS.SDK.min.js"></script>
  <script>
    // Sets up the initial handshake with the host frame
    VSS.init({applyTheme: true, explicitNotifyLoaded: true});

    // http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
    function GetURLParameter(sParam)
    {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++)
      {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam)
        {
            return sParameterName[1];
        }
      }
    }

    var initialProduct = GetURLParameter('key');

    var selectorDialog = (function(id) {
        var callbacks = [];

        function inputChanged() {
            // Execute registered callbacks
            for(var i = 0; i < callbacks.length; i++) {
                callbacks[i](isValid());
            }
        }

        function isValid() {
            // Check whether form is valid or not
            return true;
        }

        function getFormData() {
            // Get form values
            return {
                productName: $("#product-name").html(),
                productKey: $("#key-name").html(),
                selectedProducts:$("#selected-products").html()
            };
        }

        return {
            isFormValid: function() {
                return isValid();   
            },
            getFormData: function() {
                return getFormData();
            },
            attachFormChanged: function(cb) {
                  callbacks.push(cb);
            }
        };
    })();

    // Register form object to be used across this extension
    VSS.register("form-selector-dialog", selectorDialog);
  </script>
</head>
<body>

  <div>
    <!--
    Product:</br>
    <select id="products"></select></br></br>
    Version:</br>
    <select id="products-1"></select></br></br>
    <div id="key-name" hidden="true"></div>
    <div id="product-name"  hidden="true"></div>
    -->

    Search: <input id="searchQuery" type="text" style="width: 250 px"><br/>
    <select id="products" size="10" style="width: 400px" multiple></select>
    <div id="key-name" hidden="true"></div>
    <div id="product-name"  hidden="true"></div>
    <div id="selected-products"  hidden="true">[]</div>
  </div>

  <script>
      var runLocal = false;
      var localURL = 'https://azdo-dev.natinst.com:8443';
      var products = [];
      var loadedProducts = false;

      function getDoc(file, cb)
      {
        if(runLocal){
          //Run Locally
          $.ajax({url: localURL+"/devGetDoc?doc="+file, success: function(result){
            cb(result);
          }});
        }else{
          // Run on VSS          
          // Get data service
          VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
              // Get document by id
              dataService.getDocument("ProductCollection", file).then(function(file) {
                cb(file.data);
              }, function (err){
                console.log(err);
              });
          });
        }
      }

      /*

      function loadData()
      {
          // TODO: Error handle the doc failing to load
          getDoc('allproducts', function(result)
            {
              console.log(result);
                pmdmProducts = JSON.parse(result);
                $('#products').append("<option value=\"\"></option>");
                for(product in pmdmProducts){
                    $('#products').append("<option value=\"" + product + "\">" + pmdmProducts[product].name + "</option>");
                }                   
                updateProductDropdowns();
                VSS.notifyLoadSucceeded();
            }
          );
      }

      subProducts = [];

      function updateProductDropdowns(){
        var product = pmdmProducts[$('#products').val()];
        // TODO Catch failure
        if(typeof(product) == "undefined" || product.length == 0 || !product.children){
          $('#products-1').empty();
        }else{
          subProducts = pmdmProducts[$('#products').val()]['children'];
          $('#products-1').empty();
          $('#products-1').append("<option value=\"\"></option>");
          for(product in subProducts){
            $('#products-1').append("<option value=\"" + subProducts[product].key + "\">" + subProducts[product].name + "</option>");
          }
          updateLabel();
        }

      }

      $('#products').on("change",function (){
        updateProductDropdowns();
        updateLabel();
      });


      $('#products-1').on("change", function () { 
        updateLabel();
      });
      
      function updateLabel()
      {
        var product = pmdmProducts[$('#products').val()].key || "";
        var version = $('#products-1').val() || "";
        
        var fullKey = product;

        // There's probably some fancy concise way of doing this, but it works for now.
        if(version.length > 0)
        {
          fullKey = fullKey + "," + version;
        }

        $('#key-name').html(fullKey);
        $('#product-name').html(($('#products option:selected').text() + ' ' + $('#products-1 option:selected').text()).trim());
      }

      loadData();
*/
      
      var idx = {};

      /*
      function LoadProductList(cb){
        console.log("Begin Loading " + (new Date()).getTime());
        getDoc('allproducts', function(result)
            {
            console.log("got products " + (new Date()).getTime());
            var productList = JSON.parse(result);
            products = [];

            for(i in productList){
                products.push({name: productList[i].name, key:productList[i].key + ";"})
                for(x in productList[i].children){
                    products.push({name: productList[i].name + ": " + productList[i].children[x].name, key:productList[i].key + "," + productList[i].children[x].key + ";"})
                }
            }

            idx = lunr(function() {
                this.ref('index');
                this.field('name');
                for (i in products) {
                    products[i].index=i;
                    this.add(products[i]);
                }
            });
            console.log("Built index " + (new Date()).getTime());
            VSS.notifyLoadSucceeded();
          }, function(err){
            console.log("Error loading products");
          }
        );
      }*/

      function LoadProductList(cb){
        console.log("Begin Loading " + (new Date()).getTime());
        getDoc('allproducts', function(result)
            {
            console.log("got products " + (new Date()).getTime());
            var productList = JSON.parse(result).products;
            products = [];

            for(i in productList){
                products.push({name: productList[i].name, key:productList[i].key + ";"})
                for(x in productList[i].children){
                    products.push({name: productList[i].name + ": " + productList[i].children[x].name, key:productList[i].key + "," + productList[i].children[x].key + ";"})
                }
            }

            idx = lunr.Index.load(JSON.parse(result).idx);
            console.log("Built index " + (new Date()).getTime());
            VSS.notifyLoadSucceeded();
          }, function(err){
            console.log("Error loading products");
          }
        );
      }

      $("#searchQuery").on('input',function (){
        $("#products").empty();
        var results = idx.search($(this).val());
        for(i in results){
            $("#products").append("<option value=\"" + results[i].ref + "\">" + products[results[i].ref].name + "</option>")
        }
      });

      $("#products").on('change', function(){
        var selectedProducts = [];
        for(i in $("#products").val()){
          selectedProducts.push({name: products[$("#products").val()[i]].name,key: products[$("#products").val()[i]].key})
        }
        $("#selected-products").html(JSON.stringify(selectedProducts));
      });

      LoadProductList();
  </script>
</body>
</html>