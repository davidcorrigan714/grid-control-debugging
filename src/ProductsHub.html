<!DOCTYPE html style="height: 100%">

<script src="js/jquery.min.js"></script>
<script src="js/jquery-ui.min.js"></script>

<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-datepicker.min.js"></script>

<link href="css/bootstrap-datepicker.min.css" rel="stylesheet">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/jquery-ui.min.css"  rel="stylesheet">

<script src="js/lunr.min.js"></script>

<!-- for ie -->
<script src="https://www.promisejs.org/polyfills/promise-6.1.0.js"></script>

<head>
  <script src="libs/VSS.SDK.min.js"></script>
  <script>
    // Sets up the initial handshake with the host frame
    VSS.init({
      explicitNotifyLoaded: true,
      usePlatformScripts: true,
      applyTheme: true
    });

  </script>
</head>
<body style="height: 100%">
  <div class="container">
    <div class="row">
      <h3>NI Products</h3>
    </div>
    <br/>
    <h5><div id="error-text" style="color: red"></div></h5>
    <div id="main-container" hidden>
      <div class="actions-control toolbar" id="menubar" hidden></div>
      <br/>
      <div class="row">
        <div class="col col-lg-2">
          <h3>Products</h3>
        </div>
      </div> 
      <div class="row overflow-auto">
        <div class="col col-lg-12 overflow-auto" style="height: 75%" >
          <div id="productTree"></div>
        </div>
          <div class="col col-lg-4" hidden>
            <h2 id="info-product">Selected Product</h2>
            <h4 id="info-version">Version</h4>
            <div id="info-date-area" hidden="true">
              <h5>First Availability:</h5>
              <input type="text" id="info-date" class="form-control" value="1980-01-01" readonly="true"> </input>
            </div>
            <div id="info-imported"></div>
            <button type="button" id="info-external-update" onClick="updateFromPMDM()" hidden="true">Update from PMDM</button>
            <input id="info-node" hidden="true"></input>
            <div>Key:</div>
            <div id="info-key"></div>
          </div>
        </div>
      </div>
  </div>

  <!-- TODO: Generalize/Abstract the modals -->

  <!-- Modal -->
  <!-- New Manaul Product -->
  <div class="modal fade" id="manualModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content ui-dialog" style="display: flex">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New Product</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="ui-widget">
                <label for="newManualProductName">Name:</label>
                <input id="newManualProductName">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" data-dismiss="modal">Cancel</button>
          <button type="button" id="new-manual-product-ok" onClick="newProductCompletion()" data-dismiss="modal" >Add Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <!-- New Version -->
  <div class="modal fade" id="newProductVersionModal" tabindex="-1" role="dialog" aria-labelledby="newProductName" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content ui-dialog" style="display: flex">
        <div class="modal-header">
          <h5 class="modal-title" id="newProductVersionName">New Product Version</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col col-sm-4">
                <label for="newVersionName">Version Name:</label>
              </div>
              <div class="col col-sm-2"></div>
              <div class="col col-sm-4">
                First Available:
              </div>
            </div>
            <div class="row">
              <div class="col col-sm-4">
                <input id="newVersionName">
              </div>
              <div class="col col-sm-2"></div>
              <div class="col col-sm-4">
                <input type="text" id="new-version-date" class="form-control"></input>
              </div>
            </div>
            <input hidden="true" id="newVersionProduct"></input>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" data-dismiss="modal">Cancel</button>
          <button type="button" data-dismiss="modal" onClick="newVersionCompletion()" >Add Product</button>
          <br/>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <!-- PMDM Software Import -->
  <div class="modal fade" id="pmdmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content ui-dialog" style="display: flex">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Import from PMDM</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
                <div class="pmdmAutoFill">
                  <div class="ui-widget">
                    <label for="tags">PMDM Products:</label>
                    <input id="tags"></input>
                  </div>
                    <input id="toAddPMDMid" hidden />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
              Start typing then select a product from the autocomplete.
              </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" data-dismiss="modal">Cancel</button>
          <button type="button" onClick="addPMDMProduct()" data-dismiss="modal" >Add Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <!-- PMDM Hardware Import -->
  <div class="modal fade" id="pmdmHardwareModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content ui-dialog" style="display: flex">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Import from PMDM</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
                <div class="pmdmHardwareAutoFill">
                  <div class="ui-widget">
                    <label for="hardwareTags">PMDM Products:</label>
                    <input id="hardwareTags"></input>
                  </div>
                    <input id="toAddPMDMHardwareid" hidden />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col">
              Start typing then select a product from the autocomplete.
              </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" data-dismiss="modal">Cancel</button>
          <button type="button" onClick="addPMDMHardwareProduct()" data-dismiss="modal" >Add Product</button>
        </div>
      </div>
    </div>
  </div>

  <script>
      var localURL = 'https://azdo-dev.natinst.com/pmdmConnector';
      var pmdmProducts = [];
      var pmdmHardwareProducts = [];
      var dialog;
      var allProducts = [];
      var grid;
      var Grids;
      var authorized = false;

      VSS.require(["VSS/Controls/Dialogs"], function (Dialogs) {
        dialog = Dialogs
      });

      // TODO Disable things if PMDM connection doesn't work

      function setAllActive(nodes){
        for(var i in nodes){
          nodes[i].active = true;
          setAllActive(nodes[i].children);
        }
      }

      function addGridKeys(row, currentKey){
        for(var i in row)
        {
          row[i].gridKey = currentKey;
          currentKey += 1;
          currentKey = addGridKeys(row[i].children,currentKey);
        }
        return currentKey;
      }

      function sortProducts(a,b){
        if(typeof(a['name']) == 'undefined' || typeof(b['name']) == 'undefined'){
          return 1;
        }
        if(a['name'].toUpperCase() > b['name'].toUpperCase()){
          return 1;
        }else{
          return -1;
        }
      }

      // Sorts by firstAvailable or the node name
      function sortProductsChildren(node1, node2){
        if('firstAvailable' in node1 && 'firstAvailable' in node2)
        {
          // The date string is 'YYYY-MM-DD' so we can sort by ASCII
          if(node1.firstAvailable > node2.firstAvailable)
          {
            return -1;
          }else if (node1.firstAvailable < node2.firstAvailable){
            return 1;
          }else{
            if(node1.name.toLowerCase() < node2.name.toLowerCase()){
              return 1;
            }else{
              return -1;
            }
          }
        }else{
          if(node1.name.toLowerCase() < node2.name.toLowerCase()){
            return -1;
          }else{
            return 1;
          }
        }
      }

      function childrenContain(children, gridKey){
        for(var i in children){
          if(children[i].gridKey == gridKey){
            return true;
          }
          if(childrenContain(children[i].children,gridKey))
            return true;
        }
        return false;
      }

      function getRootNode(gridKey)
      {
        for(var i in allProducts)
        {
          if(allProducts[i].gridKey == gridKey){
            return allProducts[i];
          }
          if(childrenContain(allProducts[i].children,gridKey))
            return allProducts[i];
        }
        return -1;
      }

      function getNode(gridKey, node)
      {
        for(var i in node)
        {
          if(node[i].gridKey == gridKey){
            return node[i];
          }
          var node2 = getNode(gridKey, node[i].children);
          if(node2){
            return node2;
          }
        }
        return null;
      }

      function deleteItems(gridKeysToDelete){
          var searchLen = allProducts.length;
          for(var i = 0;i<searchLen;i++){
            var childSearchLen = allProducts[i].children.length;
            for(var x = 0;x<childSearchLen;x++){
              if(gridKeysToDelete.includes(allProducts[i].children[x].gridKey)){
                allProducts[i].children.splice(x,1);
                x--;
                childSearchLen--;
              }
            }
            if(gridKeysToDelete.includes(allProducts[i].gridKey)){
              allProducts.splice(i,1);
              i--;
              searchLen--;
            }
          }
          refreshGrid();
        }

      function updateProductInfoSidebar(){
        var indices = grid.getSelectedDataIndices();

        if(indices.length == 1) {
          var rowData = grid.getRowData(indices[0]);
          var rootNode = getRootNode(rowData.gridKey);

          // Root node is the product name
          $("#info-product").html(rootNode.name);

          $("#info-key").html(rowData.key);
          if (rowData.gridKey == rootNode.gridKey){
            // Root Node
            $("#info-version").html('');
            $("#info-external-update").attr("hidden",!rootNode.imported || !authorized);
            $("#info-date-area").attr("hidden",true);
            if(rootNode.imported){
              $("#info-imported").text("Imported from " + rootNode.source + ".");
            }else{
              $("#info-imported").text("");
            } 
          }else{
            // Not the root node
            $("#info-version").html(rowData.name);
            $("#info-date").attr("readonly", rootNode.imported || !authorized);
            $("#info-date").datepicker('update',rowData.firstAvailable);
            $("#info-date-area").attr("hidden",false);
            $("#info-imported").text("");
            $("#info-external-update").attr("hidden",true);
          }
        }else{
          ResetProductInfo();
        }
      }

      function refreshGrid()
      {
        allProducts.sort(sortProducts);
        addGridKeys(allProducts,0);
        grid.setDataSource(new Grids.GridHierarchySource(allProducts));
        grid.collapseAllNodes();
      }

      function flagDirty()
      {
        window.onbeforeunload = function() {
          return "Are you sure you want to navigate away?";
        }
      }

      function clearDirty(){
        window.onbeforeunload = null;
      }

      var getDoc = function(file){
        return new Promise(function(resolve, reject)
        {
          VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
              // Get document by id
              dataService.getDocument(VSS.getWebContext().project.id, file).then(function(file) {
                resolve(file.data);
              }, function (err){
                reject(err); // test for err.status == 404
              });
          });
        });
      }

      VSS.require(["VSS/Controls","VSS/Controls/Grids"], function(Controls, grids) {
        console.log("Creating a grid!");
        Grids = grids;
        var container = $("#productTree");

        var gridOptions = {
          allowTextSelection: true,
          height: "100%",
          width: "100%",
          columns: [
            { text: "Name", width: 450, index: "name" },
            { text: "Source", width: 60,
              getCellContents: function (rowInfo, dataIndex, expandedState, level, column, indentIndex, columnOrder)  {
                var node = grid.getRowData(rowInfo.dataIndex);
                var root = getRootNode(node.gridKey);
                var divStuff = "role='row' style='width:"+column.width+"px' class='grid-cell'";
                if(node == root){
                  return $("<div "+divStuff+" class='grid-cell'>"+node.source+"</div>");
                }else{
                  return $("<div "+divStuff+" class='grid-cell'></div>");
                }
              }
            },
            { text: "Active", width: 60, getCellContents: function  (rowInfo, dataIndex, expandedState, level, column, indentIndex, columnOrder)  {
                var node = grid.getRowData(rowInfo.dataIndex);
                var divStuff = "role='row' style='width:"+column.width+"px' class='grid-cell'";
                if('active' in node && node.active){
                  return $("<div "+divStuff+"><a href='#' onClick='toggleActive("+node.gridKey+")'>Y</a></div>");
                }else{
                  return $("<div "+divStuff+"><a href='#' onClick='toggleActive("+node.gridKey+")'>N</a></div>");
                }
              }
            },
//            { text: "Key", width: 120, index: "key" },
            { text: "First Available", width: 100,
              getCellContents: function (rowInfo, dataIndex, expandedState, level, column, indentIndex, columnOrder)  {
                var node = grid.getRowData(rowInfo.dataIndex);
                var root = getRootNode(node.gridKey);
                var divStuff = "role='row' style='width:"+column.width+"px' class='grid-cell'";
                if(node != root){
                  if(root.imported){
                    if('firstAvailable' in node){
                      return $("<div "+divStuff+">"+node.firstAvailable+"</div>");
                    }else{
                      return $("<div "+divStuff+"></div>");
                    }
                  }else{
                    if('firstAvailable' in node){
                      return $("<div "+divStuff+"><a href='#' onClick='setDate("+node.gridKey+");'>"+node.firstAvailable+"</a></div>");
                    }else{
                      return $("<div "+divStuff+"><a href='#' onClick='setDate("+node.gridKey+");'); return false;'>Set Date</a></div");
                    }
                  }
                }else{
                  return $("<div "+divStuff+"></div>");
                }
              }
            }
          ]
        };

        grid = Controls.create(grids.Grid, container, gridOptions);
        loadGridFromDB();
      });

      function toggleActive(dataIndex)
      {
        var node = getNode(dataIndex, allProducts);
        if('active' in node){
          node.active = !node.active;
        }else{
          node.active = true;
        }
        grid.redraw();
      }

      function setDate(dataIndex)
      {
        console.log("Date: " + dataIndex);
        return false;
      }

      $("#productTree").bind("selectedIndexChanged",function (args) {
        if(typeof(grid) == 'undefined') return;
        updateProductInfoSidebar();
      });

      function loadGridFromDB(){
        getDoc("products").then( function(result){
          allProducts = result;
          refreshGrid();
          $("#main-container").attr("hidden",false);

          VSS.notifyLoadSucceeded();

          checkUserAccess();
        },
          function(err){
            if(err.status == 404){
              allProducts = [];
              refreshGrid();
              $("#main-container").attr("hidden",false);

              VSS.notifyLoadSucceeded();

              checkUserAccess();
            }else{
              console.log("Error loading all docs " + JSON.stringify(err));
            }
          }
        );
      }

      $('#info-date').datepicker({
        format: "yyyy-mm-dd",
        enableOnReadonly: false
      });

      $('#info-date').on('changeDate', function (){
        // TODO
        flagDirty();
        // var ref = $('#jstree_demo').jstree(true);
        // var node = $('#info-node').val();
        // ref.get_node(node).original.firstAvailable = $('#info-date').datepicker('getFormattedDate');
        // ref.sort(ref.get_node(ref.get_node(node).parent).id, true);
      });

      function ResetProductInfo(){
        $("#info-product").html("Selected Prodcut");
        $("#info-version").html("");
      }

      function productKeyExists(key)
      {
        for(var i in allProducts){
          if( allProducts[i].key == key){
            return true;
          }
        }
        return false;
      }

      function SoftwareProductFromPMDM(productId){
        // TODO Sanitize product names from pmdm
        flagDirty();
        $.ajax({url: localURL+"/pmdmsoftwareproduct?productId="+productId, success: function(result){
          var products = JSON.parse(result);
          if(productKeyExists(products.key)){
            alert("Product already exists.");
          }else{
            setAllActive(products);
            allProducts.push(products);
            refreshGrid();
          }
        }});
      }

      function HardwareProductFromPMDM(productId){
        // TODO Sanitize product names from pmdm
        flagDirty();
        $.ajax({url: localURL+"/pmdmhardwareproduct?productId="+productId, success: function(result){
          var products = JSON.parse(result);
          if(productKeyExists(products.key)){
            alert("Product already exists.");
          }else{
            setAllActive(products);
            allProducts.push(products);
            refreshGrid();
          }
        }});
      }

      // Autocomplete for the pmdm dialog
      $.ajax({url: localURL+"/pmdmsoftwareproducts", success: function(result){
        pmdmProducts = JSON.parse(result);
        pmdmProducts.sort();
        var tagValues = [];
        for(var product in pmdmProducts){
          tagValues.push({label:pmdmProducts[product].name, value:pmdmProducts[product].productId})
        }
        $( "#tags" ).autocomplete({
          source: tagValues,
          select: function(event, ui)
            {
              var id = ui.item.value;
              var name = ui.item.label;
              $("#toAddPMDMid").val(ui.item.value);
              $("#tags").val(name);
              return false;
            },
          focus: function(event, ui){
            return false;
          }
        });
        $( "#tags" ).autocomplete( "option", "appendTo", ".pmdmAutoFill" );
      }});

      // Autocomplete for the pmdm dialog
      $.ajax({url: localURL+"/pmdmhardwareproducts", success: function(result){
          pmdmHardwareProducts = JSON.parse(result);
          pmdmHardwareProducts.sort();
          var tagValues = [];
          for(var product in pmdmHardwareProducts){
            tagValues.push({label:pmdmHardwareProducts[product].name, value:pmdmHardwareProducts[product].productId})
          }
          $( "#hardwareTags" ).autocomplete({
            source: tagValues,
            select: function(event, ui)
                    {
                      var id = ui.item.value;
                      var name = ui.item.label;
                      $("#toAddPMDMHardwareid").val(ui.item.value);
                      $("#hardwareTags").val(name);
                      return false;
                    },
            focus: function(event, ui){
              return false;
            }
          });
          $( "#hardwareTags" ).autocomplete( "option", "appendTo", ".pmdmHardwareAutoFill" );
      }});

      function addPMDMProduct(){
        var found = false;
        var found = pmdmProducts.find(function (element) { return element.productId == $("#toAddPMDMid").val();});
        if(found === undefined ){
          alert($("#tags").val() + " not found");
        }else{
          flagDirty();
          SoftwareProductFromPMDM(found.productId);
        }
        $("#tags").val("");
        $("#toAddPMDMid").val("");
      }

      function addAllSoftwareProducts(){
        var toAdd = [];
        flagDirty();
        for(var id in pmdmProducts)
        {
          var productId = pmdmProducts[id].productId;

          $.ajax({url: localURL+"/pmdmsoftwareproduct?productId="+productId, async:false, success: function(result){
            var products = JSON.parse(result);
            if(!productKeyExists(products.key)){
              allProducts.push(products);
            } 
          }});
        }
        refreshGrid();
      }
      
      function addAllHardwareProducts(){
        var toAdd = [];
        flagDirty();
        for(var id in pmdmHardwareProducts)
        {
          var productId = pmdmHardwareProducts[id].productId;

          $.ajax({url: localURL+"/pmdmhardwareproduct?productId="+productId, async:false, success: function(result){
            var products = JSON.parse(result);
            if(!productKeyExists(products.key)){
              allProducts.push(products);
            } 
          }});
        }
        refreshGrid();
      }
      
      function addPMDMHardwareProduct(){
        var found = false;
        var found = pmdmHardwareProducts.find(function (element) { return element.productId == $("#toAddPMDMHardwareid").val();});
        if(found === undefined ){
          alert($("#toAddPMDMHardwareid").val() + " not found");
        }else{
          flagDirty();
          HardwareProductFromPMDM(found.productId);
        }
        $("#hardwareTags").val("");
        $("#toAddPMDMHardwareid").val("");
      }

      function newProductCompletion(){
        flagDirty();
        var product = $("#newManualProductName").val();
        console.log("Adding: "+product);
        if (product != null && product != "") {
          key = sanitizeKey("custom" + product);
          if(productKeyExists(key)){
            alert("Product already exists.")
          }else{
            allProducts.push({
              name: sanitizeProductName(product),
              children: [],
              imported: false,
              source: 'AzDO',
              key: key,
              active: true
            });
            refreshGrid();
            console.log("Added");
          }
        }
        $("#newManualProductName").val("");
      }

      function newVersionPopup(){
        var selected = grid.getSelectedDataIndices();
        if(selected.length == 0){
          alert("No product selected.\n");
          return;
        }
        if(selected.length > 1){
          alert("Only select one product for a new version.\n");
          return;
        }
        if(getRootNode(grid.getRowData(selected[0]).gridKey).imported){
          alert("Cannot add versions to imported products.\n");
          return;
        }

        $("#newProductVersionName").html("New Product Version - " + getRootNode(grid.getRowData(selected[0]).gridKey).name);
        $('#newProductVersionModal').modal();
        $('#newVersionProduct').val(getRootNode(grid.getRowData(selected[0]).gridKey).gridKey);
      }

      function newVersionCompletion(){
        flagDirty();
        var productNode = getRootNode($('#newVersionProduct').val());

        // TODO: Validate new-version-date
        productNode.children.push({
          name: $('#newVersionName').val(),
          children: [],
          key: sanitizeKey($('#newVersionName').val()),
          firstAvailable: $('#new-version-date').datepicker('getFormattedDate'),
          active: true
        });

        productNode.children.sort(sortProductsChildren);
        refreshGrid();
      }

      function sanitizeProductName(name){
        return name.replace(/;/g,"");
      }

      function sanitizeKey(key){
        return key.toLowerCase().replace(/,/g,"").replace(/;/g,"").replace(/ /g,"").replace(/&/g,"");
      }

      function setDoc(file, contents, force){
        force = force || false;
        console.log("Trying to save"+file);
        var myDoc = {
          id: file,
          data: contents,
          __etag: -1 //TODO Not this
        };

        VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
          console.log("Got the service");
          dataService.setDocument(VSS.getWebContext().project.id, myDoc).then(function(doc) {
            console.log("Saved "+file);
          }, function (err){
            console.log("Error setting document"+file+"on remote serner.");
            alert("Error setting document"+file+"on remote serner.");
          });
        }, function (err){
            console.log("Error getting service.");
            alert("Error getting service.");
          }
        );
      }

      function updateFromPMDM(){
        flagDirty();
        var selected = grid.getSelectedDataIndices();
        if(selected.length != 1){
          alert("Invalid Selection\n");
          return;
        }

        var rootNode = getRootNode(grid.getRowData(selected[0]).gridKey);

        if(!rootNode.imported || rootNode.source != "pmdm"){
          alert("Product not from pmdm");
          return;
        }

        var product = rootNode.key;
        var pmdmType = rootNode.key.substring(0,5);
        var pmdmProductId = rootNode.key.substring(5);

        if(pmdmType == "pmdms"){
          deleteItems([rootNode.gridKey]);
          SoftwareProductFromPMDM(pmdmProductId);
          alert("Product updated\n");
        }else if(pmdmType == "pmdmh"){
          deleteItems([rootNode.gridKey]);
          HardwareProductFromPMDM(pmdmProductId);
          alert("Product updated\n");
        }else{
          alert("Invalid pmdm key.");
        }
      }

      $('#new-version-date').datepicker({
        format: "yyyy-mm-dd",
        enableOnReadonly: false
      });
      
      $('#pmdmModal').on('shown.bs.modal', function () {
          $('#tags').trigger('focus');
      });

      $('#pmdmHardwareModal').on('shown.bs.modal', function () {
        $('#hardwareTags').trigger('focus');
      });

      $('#manualModal').on('shown.bs.modal', function () {
        $('#newManualProductName').focus();
      });

      function save()
      {
        // Save the main config used by the hub
        setDoc("products", allProducts);

        // Generate the condensed objects for the search indexer and selector form 

        // n = name, k = key, c = children
        var fullTreeCollapsed = []; // Removes Extraneous fields
        for (var i in allProducts) {
          var toAdd = { n: allProducts[i].name, k: allProducts[i].key, c: [] };
          for(var x in allProducts[i].children) {
            toAdd.c.push({ n: allProducts[i].children[x].name, k: allProducts[i].children[x].key });  
          }
          fullTreeCollapsed.push(toAdd);
        }

        var flatProducts = [];
        for(var i in fullTreeCollapsed){ // Collapses the tree into a flat list for the index
          flatProducts.push({n: fullTreeCollapsed[i].n})
          for(var x in fullTreeCollapsed[i].c){
            flatProducts.push({n: fullTreeCollapsed[i].n + ": " + fullTreeCollapsed[i].c[x].n})
          }
        }

        // Remove the stop word filter from the indexing process.
        // Otherwise you can't search for 'CAN' devices.
        // Looking at the lunr code and filtered words it doesn't seem to be necessary for our dataset of product names
        lunr.stopWordFilter =  lunr.generateStopWordFilter([]);
        lunr.Pipeline.registerFunction(lunr.stopWordFilter, 'stopWordFilter')

        var idx = lunr(function(builder) {

          this.ref('i');
          this.field('n');
          for (var i in flatProducts) {
            flatProducts[i].i=i;
            this.add(flatProducts[i]);
          }
        });

        setDoc("allproducts",{idx: JSON.stringify(idx), products: fullTreeCollapsed});

        clearDirty();
        console.log("Done saving!");
      }

      VSS.require(["VSS/Controls", "VSS/Controls/Menus"], function(Controls, Menus) {
        var container = $("#menubar");

        var menuItems = [
          { id: "new-product", text: "New Product",  noIcon: true  },
          { separator: true },
          { id: "new-version", text: "New Version", noIcon: true },
          { separator: true },
          { id: "import-pmdm-software", text: "Import Software - PMDM", noIcon: true },
          { separator: true},
          { id: "import-pmdm-hardware", text: "Import Hardware - PMDM", noIcon: true },
          { separator: true},
/*
          { id: "import-1000-software", text: "All Software ", noIcon: true },
          { separator: true },
          { id: "import-1000-hardware", text: "All Hardware", noIcon: true },
          { separator: true },
*/
          { id: "delete-items", text: "Delete Selected", noIcon: true },
          { separator: true },
          { id: "save", text: "Save", noIcon: true },
          { separator: true }
        ];

        var menubarOptions = {
          items: menuItems,
          executeAction: function (args) {
            var command = args.get_commandName();
            switch (command) {
              case "new-product":
                $("#manualModal").modal();
                break;
              case "new-version":
                newVersionPopup();
                break;
              case "import-pmdm-software": 
                $("#pmdmModal").modal();
                break;
              case "import-pmdm-hardware":
                $("#pmdmHardwareModal").modal();
                break;
              case "import-1000-software":
                addAllSoftwareProducts();
                break;
              case "import-1000-hardware":
                addAllHardwareProducts();
                break;
              case "delete-items":
                var gridKeysToDelete = [];
                var indices = grid.getSelectedDataIndices();
                if(indices.length == 0){
                  alert("No items selected.");
                  return;
                }

                flagDirty();

                for(var i in indices){
                  gridKeysToDelete.push( grid.getRowData(indices[i]).gridKey);
                }

                deleteItems(gridKeysToDelete);
                break;
              case "save":
                save();
                break;
              default:
                alert("Unhandled action: " + command);
                break;
            }
          }
        };
        var menubar = Controls.create(Menus.MenuBar, container, menubarOptions);
      });

    $('#newManualProductName').keypress(function(event) {
      if (event.keyCode == 13 || event.which == 13) {
        $("#manualModal").modal('hide');
        newProductCompletion();
      }
    });

    function restCall(token, url){
      var ret;
      $.ajax({async:false,
          url: url ,
          dataType: 'json',
          async:false,
          headers: { 'Authorization': 'Basic ' + btoa(":"+token)},
          success: function(data, textStatus, request){
            ret = data;
            // TODO: Handle continuations
            //console.log(request.getResponseHeader('X-MS-ContinuationToken'));
          }
      });
      return ret;
    }

    function checkUserAccess()
    {
      VSS.getAccessToken().then(function(token){
        var token = token.token;
        var webContext = VSS.getWebContext();
        var org = webContext.collection.name;
        var userID = webContext.user.id;
        var userDescriptor = '';
        
        var userDescriptor = restCall(token,"https://vssps.dev.azure.com/"+org+"/_apis/graph/descriptors/"+userID+"?api-version=5.0-preview.1").value;

        var groups = restCall(token, "https://vssps.dev.azure.com/"+org+"/_apis/graph/groups?api-version=5.0-preview.1").value;
        var groupName = "["+webContext.project.name+"]\\Product Administrators";
        groupName = groupName.toUpperCase();
        var groupDescriptor = ''
        for(var i in groups)
        {
          if(groups[i].principalName.toUpperCase() == groupName)
          {
            groupDescriptor = groups[i].descriptor;
            break;
          }
        }
        if(groupDescriptor == '')
        {
          $("#error-text").html("'Product Administrators' group not found in project.");
          return;
        }
        var auth = restCall(token,"https://vssps.dev.azure.com/" + org + "/_apis/graph/memberships/" + userDescriptor + "/" + groupDescriptor + "?api-version=5.0-preview.1");

        if(typeof(auth) == 'undefined'){
          // Nope
          $("#error-text").html("You must be a member of 'Product Administrators' to edit the product database.");
        }else{
          //User is authorized
          $("#menubar").attr("hidden",false);
          authorized = true;
        }
      });
    }
  </script>
</body>
</html>